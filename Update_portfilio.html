<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ashish Rijal - Portfolio</title>

  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  
  <style>
    /* === CSS STARTS === */
    body {
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
/* Home section specific background */
    #home {
    background-size: cover;
    background-position: center;
    text-align: center;
    color: white;
    padding: 50px 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7); /* For better text visibility */
}
/* Anchor hover effects for all links */
a:hover {
    color: rgb(97, 138, 138); /* General hover effect */
}
a:active {
    color: #555;
}
/* Specific Hover Effect for Geomatics Engineering Society */
#home p a {
    color: #ffd700; /* Default color for the link */
    transition: color 0.3s ease;
}
#home p a:hover {
    color: rgb(97, 138, 138); /* Hover color for Geomatics Engineering Society link */
}
    /* Navigation Bar */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: #20022c;
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
/* Container and Flex layout */
    .nav-container {
      width: 90%;
      max-width: 1200px;
      margin: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
   /* Logo */ 
.logo {
    color: white;
    margin: 0;
}
    .nav-links {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    .nav-links li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s;
    }

    .nav-links li a:hover,
    .nav-links li a.active {
      color: #ffd700;
    }
    /* Responsive for mobile */
@media (max-width: 768px) {
    .nav-links {
        flex-direction: column;
        background-color: #222;
        position: absolute;
        top: 60px;
        right: 0;
        width: 200px;
        display: none;
    }
    .nav-links.show {
        display: flex;
    }

    .menu-toggle {
        display: block;
        color: white;
        font-size: 24px;
        cursor: pointer;
    }
}

    h2 {
      display: inline-block;
      background-color: #431a4b;
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      margin-bottom: 10px;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transitions */
    }
    nav {
    background-color: #333;
    padding: 10px;
}
nav ul {
    list-style-type: none;
    display: flex;
    justify-content: center;
}
nav ul li {
    margin: 0 15px;
}
nav ul li a {
    color: white;
    text-decoration: none;
    font-weight: bold;
}
p a {
    color: #333;
}
  #home h1 {
    margin: 20px 0;
}

#home p {
    font-size: 1.2rem;
}


    /* About Section */
    #about {
      background-color: #675288;
       padding: 40px;
      text-align: center;
    }
  #about h2 {
    font-size: 2.5rem;
    margin-bottom: 20px;
    color: white;
  }
  
    .about-box {
      background-color: #5b7b9b;
      color: black;
      padding: 25px 30px;
      max-width: 800px;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* Projects */
    #projects {
      background-color: #675288;
        padding: 40px;
    }

    .projects-list {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    .project-card {
      background-color: #5b7b9b;
      color: white;
        border: 1px solid #ddd;
      padding: 20px;
      width: 30%;
      margin: 10px;
      border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .project-card h3 {
      background-color: #20022c;
      color: white;
      padding: 10px;
      margin: 0 0 10px 0;
      text-align: center;
      border-radius: 10px;
    }

    .project-card p {
      color: black;
      padding: 10px;
    border-radius: 5px;
    }

    .project-card a {
      color: #20022c;
      text-decoration: none;
      display: inline-block;
      margin-top: 10px;
      font-size: 1rem;
    }

    .project-card a:hover {
      text-decoration: underline;
      color: #fff;
    }

    /* Education */
    #education {
      background-color: #675288;
      text-align: center;
      padding: 50px 0;
    }
    #education h2 {
    display: inline-block;
    background-color: #431a4b;
    color:white;
    padding: 8px 16px;
    border-radius: 8px;
    margin-bottom: 30px;
    font-size: 2.5rem;
  }

    .education-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      padding: 0 20px;
    }

    .education-card {
      background-color: #5b7b9b;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      text-align: left;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
     .education-card h3 {
    font-size: 1.4rem;
    margin-bottom: 8px;
  }
    .education-card p {
    margin: 4px 0;
    color: #272727;
  }
    #education a {
    color: #141414;
    text-decoration: none;
    font-weight: bold;
  }
    #education a:hover {
    color: #6a1b9a; /* Purple on hover */
    text-decoration: underline;
  }


    /* Skills */
    #skills {
      background-color: #675288;
      padding: 50px 0;
      text-align: center;
    }
  #skills h2 {
    font-size: 2.5rem;
    margin-bottom: 30px;
    color: #ffffff;
  }
    .skills-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      padding: 0 20px;
      justify-items: center;
    }
    .skill-card {
    background-color: #84b6d8; /* Blue background for entire card */
    border-radius: 12px;
    padding: 20px;
    width: 220px;
    height: 240px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s, box-shadow 0.3s;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    color: black;
  }
  .skill-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }
  .icon-box {
    background-color: #84b6d8; /* Same blue */
    border-radius: 16px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
    .icon-wrapper {
    background-color: #20022c;
    color: #fff;
    width: 70px;
    height: 70px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 10px;
    transition: transform 0.3s;
  }
    .skill-card:hover .icon-wrapper {
    transform: scale(1.1);
  }
    .icon-box h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: black; /* White text */
    margin: 0;
  }

    /* Social */
    #social-media {
      background-color: #675288;
      text-align: center;
       padding: 40px 20px;
    }
    #social-media h2 {
    font-size: 2rem;
    margin-bottom: 20px;
    color: #ffffff; /* Optional: Match theme */
}

    .social-icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .social-icons a {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #20022c;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 10px;
      font-size: 1.5rem;
       transition: background-color 0.3s, transform 0.3s;
    }

  .social-icons a:hover {
    background-color: #3b0d4d;
    transform: scale(1.1);
    color: #fff;
}  
 #routeMap {
      height: 600px;
      margin-top: 20px;
      border: 2px solid #ddd;
    }
    .leaflet-control {
  z-index: 500; /* high enough to appear over map, not over entire page */
}

     #ktmmap { height: 500px;
    width: 100%;
    position: relative;
    z-index: 0; }
    .leaflet-marker-icon.small-dot {
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
      border: 1px solid white;
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar">
  <div class="nav-container">
    <ul class="nav-links">
      <li><a href="#home">Home</a></li>
      <li><a href="#about">About</a></li>
      <li><a href="#projects">Projects</a></li>
      <li><a href="#education">Education</a></li>
      <li><a href="#skills">Skills</a></li>
      <li><a href="#social-media">Contact</a></li>
    </ul>
  </div>
</nav>

<!-- HOME -->
<section id="home" style="position: relative; height: 100vh; overflow: hidden;">
  
    <img src="bg.jpeg" alt="Background" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;" />
    <div style="position: relative; z-index: 1; color: white; text-align: center; padding-top: 100px;">
    <img src="ashish.jpeg" alt="Ashish Rijal" style="width:300px;height:300px;border-radius:50%;border:4px solid white;margin-bottom:20px;">
  <h1>Ashish Rijal</h1>
  <p>Geomatics Engineering Student | Web GIS Developer in Progress</p>
  <p>Secretary at <a href="https://ges.ku.edu.np/" target="_blank">Geomatics Engineering Society</a></p>
  <p>Student Chapter Lead at <a href="https://sc.isprs.org/members/isprs-sc-student-chapter/" target="_blank">ISPRS SC-KUGES</a></p>
</div>
</section>

<!-- ABOUT -->
<section id="about">
  <h2>About Me</h2>
  <div class="about-box">
     <p>
        I am a passionate Geomatics Engineering student at Kathmandu University with strong interests in geospatial analysis, open-source technologies, and sustainable development. 
        I have worked on projects involving GIS-based landfill site suitability and route optimization, and I am currently exploring web development to integrate geospatial data into interactive platforms. 
        As Secretary of the Geomatics Engineering Society, I am actively involved in organizing technical events and promoting innovation in the geospatial field.
      </p>
    </div>
</section>

<!-- PROJECTS -->
<section id="projects">
  <h2>Key Projects</h2>
  <div class="projects-list">
    <div class="project-card">
      <h3>Geo-Hackafest 2024 Winner</h3>
      <p>Created a utility website for spatial queries and visualizations with multi-criteria filtering.</p>
    </div>
    <div class="project-card">
      <h3>3D Physical Model of Block 9</h3>
      <p>Designed a detailed 3D model of Block 9 using topographic and architectural data.</p>
    </div>
    <div class="project-card">
       <h3>Large-Scale Solar Power Plant Site Selection Using GIS and AHP</h3>
        <p>Utilized GIS and the Analytical Hierarchy Process (AHP) to identify optimal locations for solar power plants, focusing on sustainability and efficient land use.</p>
            </div>
    <div class="project-card">
      <h3>Integrated Approach to Waste Management in Banepa Municipality</h3>
        <p>Co-authored a research paper combining GIS, AHP, and network analysis to optimize waste collection routes and identify suitable landfill sites in Banepa Municipality.</p>
        <a href="https://scholar.google.com/scholar?hl=en&as_sdt=0%2C5&q=optimal+waste+management+in+banepa&oq=" target="_blank">üìÑ Read the article on Google Scholar</a>
            </div>
    <div class="project-card">
      <h3>Traverse Calculator Using Java and GUI</h3>
                <p>Developed a desktop application for automated traverse calculations featuring a user-friendly GUI, aimed at simplifying field data processing for surveyors.</p>
            </div>
  </div>
</section>
<section>
<h2>Explore Kathmandu</h2>
<div id="ktmmap"></div>
</section>
 
<!-- EDUCATION -->
<section id="education">
  <h2>Education</h2>
  <div class="education-list">
    <div class="education-card">
       <h3>Bachelor of Engineering in Geomatics Engineering</h3>
        <p>
        <a href="https://ku.edu.np" target="_blank">Kathmandu University</a></p>
      <p>2021 ‚Äì Expected 2026</p>
      <p><strong>GPA:</strong> Currently Studying</p>
    </div>
    <div class="education-card">
      <h3>+2 Science (NEB)</h3>
      <p><a href="https://bernhardt.edu.np" target="_blank">Bernhardt College</a></p>
      <p>Graduated: 2021</p>
      <p><strong>GPA:</strong> 3.71</p>
    </div>
    <div class="education-card">
      <h3>SEE</h3>
      <p><a href="https://greenhill.edu.np" target="_blank">Green Hill School</a></p>
      <p>Graduated: 2019</p>
      <p><strong>GPA:</strong> 3.85</p>
    </div>
  </div>
</section>
<!-- Add this inside <body> where you want the tool -->

<section id="spatial-tools">
  <h2>Emergency Services Proximity Tool</h2>
  <div id="controls">
    <label for="bufferDistance">Buffer Distance (m): </label>
    <input type="number" id="bufferDistance" value="1000" min="10" step="10">
    <button onclick="loadBuffer()">Load</button>
  </div>
  <div id="map" style="height: 600px; width: 100%; margin-top: 20px;"></div>
  <div id="summary"></div>
</section>

<section id="shortest-route">
    <h2>Shortest Route to Emergency Services</h2>
    <label for="sourceSelector">Select Starting Location:</label>
    <select id="sourceSelector">
      <option value="home">Home - Chhaimale</option>
      <option value="school">Green Hill School</option>
      <option value="college">Bernhardt H.S School & College</option>
      <option value="university">Kathmandu University</option>
    </select>

    <label for="emergencyType">Select Emergency Type:</label>
    <select id="emergencyType">
      <option value="hospital">Hospital/Clinic</option>
      <option value="police">Police Station</option>
      <option value="fire_station">Fire Station</option>
    </select>

    <button onclick="findNearestEmergencyRoute()">Find Nearest Route</button>
    <div id="routeMap"></div>
  </section>
<!-- SKILLS -->
<section id="skills">
  <h2>Skills</h2>
  <div class="skills-list">
        <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fas fa-map-marker-alt"></i>
          </div>
        </div>
        <h3>GIS</h3>
      </div>
       <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fas fa-satellite-dish"></i>
          </div>
        </div>
        <h3>Remote Sensing</h3>
      </div>
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fab fa-python"></i>
          </div>
        </div>
        <h3>Python</h3>
      </div>
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fab fa-java"></i>
          </div>
        </div>
        <h3>Java</h3>
      </div>
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fab fa-html5"></i>
          </div>
        </div>
        <h3>HTML</h3>
      </div>
  
      <!-- Skill 6 -->
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fab fa-css3-alt"></i>
          </div>
        </div>
        <h3>CSS</h3>
      </div>
  
      <!-- Skill 7 -->
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fab fa-js"></i>
          </div>
        </div>
        <h3>JavaScript</h3>
      </div>
  
      <!-- Skill 8 -->
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fas fa-database"></i>
          </div>
        </div>
        <h3>PostgreSQL</h3>
      </div>
  
      <!-- Skill 9 -->
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fas fa-camera-retro"></i>
          </div>
        </div>
        <h3>Envi</h3>
      </div>
  
      <!-- Skill 10 -->
      <div class="skill-card">
        <div class="icon-box">
          <div class="icon-wrapper">
            <i class="fas fa-cogs"></i>
          </div>
        </div>
        <h3>PgAdmin</h3>
      </div>
    </div>
</section>

<!-- CONTACT -->
<section id="social-media">
  <h2>Connect with Me</h2>
  <div class="social-icons">
    <a href="https://www.facebook.com/ashish.rijal.969" target="_blank"><i class="fab fa-facebook-f"></i></a>
    <a href="https://www.instagram.com/ashish_rijal115/" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://www.linkedin.com/in/ashish-rijal-9208ba271/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
    <a href="mailto:rijalaashish1234@gmail.com"><i class="fas fa-envelope"></i></a>
  </div>
  <h3>Contact No: +977 9869682984</h3>
  <h3>Email: rijalaashish1234@gmail.com // rijalaashish1234@icloud.com</h3>
</section>
<!-- Footer Section -->
<footer style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #20022c;
  color: #fff;
  text-align: center;
  padding: 12px 10px;
  font-size: 0.95rem;
  z-index: 999;
  box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
">
  ¬© 2025 Ashish Rijal 
</footer>


<!-- === JavaScript for Smooth Scrolling === -->

document.querySelectorAll('nav a').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();

        document.querySelector(this.getAttribute('href')).scrollIntoView({
            behavior: 'smooth'
        });
    });
});
 <script>
const map = L.map('map').setView([27.6, 85.3], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const educationPOIs = [
  { name: "Home - Chhaimale", type: "Home", coords: [27.59233, 85.26010] },
  { name: "Green Hill School", type: "School", coords: [27.60870377512003, 85.26614639072862] },
  { name: "Bernhardt H.S School & College", type: "College", coords: [27.685647182665793, 85.29681450985778] },
  { name: "Kathmandu University", type: "University", coords: [27.619527688658486, 85.53879165403045] }
];

let bufferLayers = [];
let emergencyDots = [];
let poiMarkers = [];

function clearMap() {
  bufferLayers.forEach(l => map.removeLayer(l));
  bufferLayers = [];
  emergencyDots.forEach(m => map.removeLayer(m));
  emergencyDots = [];
  poiMarkers.forEach(m => map.removeLayer(m));
  poiMarkers = [];
  document.getElementById('summary').innerHTML = "";
}

function fetchEmergency(lat, lng, radiusMeters) {
  const overpassURL = 'https://overpass-api.de/api/interpreter';
  const query = `
    [out:json][timeout:25];
    (
      node["amenity"~"hospital|clinic"](around:${radiusMeters},${lat},${lng});
      way["amenity"~"hospital|clinic"](around:${radiusMeters},${lat},${lng});
      node["amenity"="police"](around:${radiusMeters},${lat},${lng});
      way["amenity"="police"](around:${radiusMeters},${lat},${lng});
      node["amenity"="fire_station"](around:${radiusMeters},${lat},${lng});
      way["amenity"="fire_station"](around:${radiusMeters},${lat},${lng});
      node["police"="traffic_police"](around:${radiusMeters},${lat},${lng});
      way["police"="traffic_police"](around:${radiusMeters},${lat},${lng});
    );
    out center;
  `;
  return fetch(overpassURL, {
    method: 'POST',
    body: 'data=' + encodeURIComponent(query),
    headers: {'Content-Type': 'application/x-www-form-urlencoded'}
  }).then(res => res.json()).then(data => data.elements);
}

function loadBuffer() {
  const distanceMeters = parseFloat(document.getElementById('bufferDistance').value);
  clearMap();

  let emergencySummary = { hospital: 0, police: 0, fire_station: 0 };

  educationPOIs.forEach(async (poi) => {
    const latlng = [poi.coords[0], poi.coords[1]];
    const center = turf.point([poi.coords[1], poi.coords[0]]);
    const buffer = turf.buffer(center, distanceMeters, { units: 'meters' });

    const bufferLayer = L.geoJSON(buffer, {
      style: { color: '#009688', weight: 2, fillOpacity: 0.2 }
    }).addTo(map);
    bufferLayers.push(bufferLayer);

    const results = await fetchEmergency(latlng[0], latlng[1], distanceMeters);
    let isSafe = results.length > 0;

    let nearbyCounts = { hospital: 0, police: 0, fire_station: 0 };
    results.forEach(el => {
      let type = el.tags?.amenity;

      if (el.tags?.police === 'traffic_police') {
        type = 'police';
      }
      if (type === 'clinic') {
        type = 'hospital';
      }
      if (type && nearbyCounts[type] !== undefined) {
        nearbyCounts[type]++;
        emergencySummary[type]++;
      }
    });

    const marker = L.marker(latlng, { riseOnHover: true }).addTo(map);
    const popupContent = `üìç ${poi.name}<br>üè´ ${poi.type}<br>${isSafe ? '‚úÖ Safe' : '‚ùå Not Safe'}<br>
      üè• Hospital: ${nearbyCounts.hospital}<br>
      üöì Police: ${nearbyCounts.police}<br>
      üöí Fire Station: ${nearbyCounts.fire_station}`;
    marker.bindPopup(popupContent).openPopup();
    poiMarkers.push(marker);

    if (map.getZoom() >= 13) {
      results.forEach(el => {
        const lat = el.lat || el.center?.lat;
        const lon = el.lon || el.center?.lon;
        if (lat && lon) {
          const dot = L.circleMarker([lat, lon], {
            radius: 4,
            color: 'red',
            fillColor: 'red',
            fillOpacity: 0.8,
            weight: 1
          }).addTo(map);

          const popupText = `
            üÜò <strong>${el.tags?.amenity || 'Unknown'}</strong><br>
            üè∑Ô∏è ${el.tags?.name || 'Unnamed'}<br>
            üìç Lat: ${lat.toFixed(5)}, Lng: ${lon.toFixed(5)}
          `;
          dot.bindPopup(popupText);

          emergencyDots.push(dot);
        }
      });
    }

    const summaryHTML = `
      <h3>Total Emergency Services Found</h3>
      <ul>
        <li>Hospital: ${emergencySummary.hospital}</li>
        <li>Police: ${emergencySummary.police}</li>
        <li>Fire Station: ${emergencySummary.fire_station}</li>
      </ul>
    `;
    document.getElementById('summary').innerHTML = summaryHTML;
  });
}

window.onload = () => {
  loadBuffer();
};
  </script>
  <script>
    const routeMap = L.map('routeMap').setView([27.6, 85.3], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(routeMap);

    const eduLocations = {
      home: {
        name: "Home - Chhaimale",
        coords: [27.59233, 85.26010]
      },
      school: {
        name: "Green Hill School",
        coords: [27.60870377512003, 85.26614639072862]
      },
      college: {
        name: "Bernhardt H.S School & College",
        coords: [27.685647182665793, 85.29681450985778]
      },
      university: {
        name: "Kathmandu University",
        coords: [27.619527688658486, 85.53879165403045]
      }
    };

    let currentRouteLine = null;

    async function loadEmergencyPoints(type) {
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"="${type}"](27.5,85.2,27.7,85.6);
          way["amenity"="${type}"](27.5,85.2,27.7,85.6);
          ${type === 'police' ? 'node["police"="traffic_police"](27.5,85.2,27.7,85.6);' : ''}
          ${type === 'police' ? 'way["police"="traffic_police"](27.5,85.2,27.7,85.6);' : ''}
          ${type === 'hospital' ? 'node["amenity"="clinic"](27.5,85.2,27.7,85.6);' : ''}
          ${type === 'hospital' ? 'way["amenity"="clinic"](27.5,85.2,27.7,85.6);' : ''}
        );
        out center;
      `;
      const response = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: 'data=' + encodeURIComponent(query),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
      const data = await response.json();
      const features = data.elements.map(el => {
        const coords = el.type === 'node' ? [el.lon, el.lat] : [el.center.lon, el.center.lat];
        return {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: coords
          },
          properties: {
            name: el.tags.name || 'Unnamed',
            type: el.tags.amenity || el.tags.police || 'unknown'
          }
        };
      });
      return turf.featureCollection(features);
    }

    async function findNearestEmergencyRoute() {
      const selectedKey = document.getElementById("sourceSelector").value;
      const selectedType = document.getElementById("emergencyType").value;
      const source = eduLocations[selectedKey];
      const fromPoint = turf.point([source.coords[1], source.coords[0]]);

      const emergencyData = await loadEmergencyPoints(selectedType);
      const nearest = turf.nearestPoint(fromPoint, emergencyData);

      if (currentRouteLine) routeMap.removeControl(currentRouteLine);

      currentRouteLine = L.Routing.control({
        waypoints: [
          L.latLng(source.coords[0], source.coords[1]),
          L.latLng(nearest.geometry.coordinates[1], nearest.geometry.coordinates[0])
        ],
        show: true,
        addWaypoints: false,
        routeWhileDragging: false,
        draggableWaypoints: false
      }).addTo(routeMap);

      L.popup()
        .setLatLng([nearest.geometry.coordinates[1], nearest.geometry.coordinates[0]])
        .setContent(`Nearest ${selectedType.replace('_', ' ')}: <br><strong>${nearest.properties.name}</strong>`)
        .openOn(routeMap);
    }
  </script>
 
<script>
  const ktmmap = L.map('ktmmap').setView([27.71, 85.32], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(ktmmap);

  let kathmanduFeature;
  let emergencyLayer, tourismLayer, localUnitLayer;
  let emergencyCounts = { hospital: 0, clinic: 0, police: 0, fire_station: 0 };
  let tourismCounts = {}; // Tourism categories counter

  const populationData = {
    "Budhanilakantha": { population: 177557 },
    "Chandragiri": { population: 136928 },
    "Dakshinkali": { population: 24056 },
    "Gokarneshwor": { population: 151200 },
    "Kageshwori Manahora": { population: 133327 },
    "Kathmandu": { population: 845767 },
    "Kirtipur": { population: 81782 },
    "Nagarjun": { population: 115507 },
    "Shankharapur": { population: 78325 },
    "Tarakeshwor": { population: 151508 },
    "Tokha": { population: 135741 }
  };

  const controls = L.control({ position: 'topright' });
  controls.onAdd = function () {
    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
    div.innerHTML = `<label style="background:white;padding:2px;display:block;"><input type="checkbox" id="toggleEmergency" checked> Emergency</label>
                     <label style="background:white;padding:2px;display:block;"><input type="checkbox" id="toggleTourism"> Tourism</label>
                     <label style="background:white;padding:2px;display:block;"><input type="checkbox" id="toggleLocal"> Local Units</label>`;
    return div;
  };
  controls.addTo(ktmmap);

  fetch('ktm.geojson')
    .then(res => res.json())
    .then(data => {
      const layer = L.geoJSON(data, {
        style: {
          color: '#0000ff', weight: 3, opacity: 1, fillOpacity: 0.1
        },
        onEachFeature: (feature, lyr) => {
          lyr.on('click', e => showPopup(e.latlng));
        }
      }).addTo(ktmmap);
      kathmanduFeature = data.features[0];
      ktmmap.fitBounds(layer.getBounds());
      fetchEmergencyServices();
    });

  document.addEventListener('change', e => {
    const id = e.target.id;
    if (id === 'toggleEmergency') {
      if (e.target.checked && emergencyLayer) ktmmap.addLayer(emergencyLayer);
      else if (emergencyLayer) ktmmap.removeLayer(emergencyLayer);
    } else if (id === 'toggleTourism') {
      if (e.target.checked) fetchTourismServices();
      else if (tourismLayer) ktmmap.removeLayer(tourismLayer);
    } else if (id === 'toggleLocal') {
      if (e.target.checked) loadLocalUnits();
      else if (localUnitLayer) ktmmap.removeLayer(localUnitLayer);
    }
  });

  function fetchEmergencyServices() {
    const query = `[out:json][timeout:25];(node["amenity"~"hospital|clinic|police|fire_station"](27.6,85.25,27.8,85.4);way["amenity"="fire_station"](27.6,85.25,27.8,85.4);relation["amenity"="fire_station"](27.6,85.25,27.8,85.4););out center tags;`;
    fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query })
      .then(res => res.json())
      .then(json => {
        const inside = json.elements.filter(el => {
          const lon = el.lon || el.center?.lon;
          const lat = el.lat || el.center?.lat;
          if (!lon || !lat) return false;
          const pt = turf.point([lon, lat]);
          return turf.booleanPointInPolygon(pt, kathmanduFeature);
        });
        emergencyCounts = { hospital: 0, clinic: 0, police: 0, fire_station: 0 };
        if (emergencyLayer) ktmmap.removeLayer(emergencyLayer);
        emergencyLayer = L.layerGroup();
        inside.forEach(el => {
          const lon = el.lon || el.center?.lon;
          const lat = el.lat || el.center?.lat;
          const type = el.tags.amenity;
          if (emergencyCounts[type] !== undefined) emergencyCounts[type]++;
          const marker = L.circleMarker([lat, lon], {
            radius: 5, fillColor: "red", color: "white",
            weight: 1, opacity: 1, fillOpacity: 0.8
          }).bindPopup(`<b>${type.replace("_", " ")}</b><br>${el.tags.name || "Unnamed"}<br>Lat: ${lat.toFixed(4)}, Lng: ${lon.toFixed(4)}`);
          emergencyLayer.addLayer(marker);
        });
        if (document.getElementById('toggleEmergency')?.checked) {
          emergencyLayer.addTo(ktmmap);
        }
      });
  }

  function fetchTourismServices() {
    const query = `[out:json][timeout:25];(node["tourism"](27.6,85.25,27.8,85.4););out center tags;`;
    fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query })
      .then(res => res.json())
      .then(json => {
        const inside = json.elements.filter(el => {
          const lon = el.lon || el.center?.lon;
          const lat = el.lat || el.center?.lat;
          if (!lon || !lat) return false;
          const pt = turf.point([lon, lat]);
          return turf.booleanPointInPolygon(pt, kathmanduFeature);
        });
        tourismCounts = {};
        if (tourismLayer) ktmmap.removeLayer(tourismLayer);
        tourismLayer = L.layerGroup();
        inside.forEach(el => {
          const lon = el.lon || el.center?.lon;
          const lat = el.lat || el.center?.lat;
          const category = el.tags.tourism || "Unknown";
          tourismCounts[category] = (tourismCounts[category] || 0) + 1;
          const marker = L.circleMarker([lat, lon], {
            radius: 5, fillColor: "blue", color: "white",
            weight: 1, opacity: 1, fillOpacity: 0.8
          }).bindPopup(`<b>Type:</b> ${category}<br><b>Name:</b> ${el.tags.name || "Unnamed"}<br>Lat: ${lat.toFixed(4)}, Lng: ${lon.toFixed(4)}`);
          tourismLayer.addLayer(marker);
        });
        tourismLayer.addTo(ktmmap);
      });
  }

  function loadLocalUnits() {
    fetch('ktmlocal.geojson')
      .then(res => res.json())
      .then(data => {
        if (localUnitLayer) ktmmap.removeLayer(localUnitLayer);
        localUnitLayer = L.geoJSON(data, {
          style: { color: '#006400', weight: 2, fillOpacity: 0.1 },
          onEachFeature: function (feature, layer) {
            layer.on('click', () => {
              const name = feature.properties.GaPa_NaPa;
              const area = turf.area(feature) / 1e6;
              const popInfo = populationData[name];
              const density = popInfo ? (popInfo.population / area).toFixed(2) : "N/A";
              const popupText = `<b>${name}</b><br>Area: ${area.toFixed(2)} sq.km<br>` +
                (popInfo ? `Population: ${popInfo.population}<br>Density: ${density} people/sq.km` : 'No population data available');
              layer.bindPopup(popupText).openPopup();
            });
          }
        }).addTo(ktmmap);
      });
  }

  function showPopup(latlng) {
    if (!kathmanduFeature) return;
    const clickedPoint = turf.point([latlng.lng, latlng.lat]);
    const inside = turf.booleanPointInPolygon(clickedPoint, kathmanduFeature);
    if (!inside) return;
    const area = turf.area(kathmanduFeature) / 1e6;
    let popupText = `<b>You are inside Kathmandu District</b><br>
      Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}<br>
      Area: ${area.toFixed(2)} sq.km`;

    if (document.getElementById('toggleEmergency')?.checked) {
      popupText += `<br><b>Emergency service counts:</b><br>
        üî¥ Hospital: ${emergencyCounts.hospital}<br>
        üè• Clinic: ${emergencyCounts.clinic}<br>
        üëÆ Police: ${emergencyCounts.police}<br>
        üöí Fire Station: ${emergencyCounts.fire_station}`;
    }

    if (document.getElementById('toggleTourism')?.checked) {
      popupText += `<br><b>Tourism sites:</b><br>`;
      for (let type in tourismCounts) {
        popupText += `üìç ${type}: ${tourismCounts[type]}<br>`;
      }
    }

    L.popup().setLatLng(latlng).setContent(popupText).openOn(ktmmap);
  }
</script>
</body>
</html>
